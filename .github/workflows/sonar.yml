# Tên của workflow, sẽ hiển thị trên tab "Actions" của GitHub
name: Build, Test and Analyze

# Điều kiện để kích hoạt workflow
on:
  # Chạy khi có code được đẩy lên nhánh 'main'
  push:
    branches:
      - main
  # Hoặc khi có Pull Request được mở, cập nhật, hoặc mở lại nhắm vào nhánh 'main'
  pull_request:
    types: [opened, synchronize, reopened]

# Định nghĩa các công việc cần thực hiện
jobs:
  sonarcloud:
    name: SonarCloud Scan
    # Chạy trên một máy ảo Ubuntu mới nhất do GitHub cung cấp
    runs-on: ubuntu-latest

    # Các bước thực thi tuần tự
    steps:
      # Bước 1: Lấy mã nguồn từ repository về máy ảo
      # Đây là bước bị thiếu trong file của bạn
      - uses: actions/checkout@v3
        with:
          # fetch-depth: 0 là cần thiết để SonarCloud có thể phân tích lịch sử commit
          fetch-depth: 0

      # Bước 2: Cài đặt môi trường Python
      # Đây cũng là bước bị thiếu trong file của bạn
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.13" # Sử dụng phiên bản Python 3 mới nhất

      # Bước 3: Cài đặt các thư viện cần thiết cho việc test
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      # Bước 4: Chạy test và tạo báo cáo độ phủ dưới dạng XML
      # - name: Test with pytest and generate coverage report
      #   continue-on-error: true
      #   run: |
      #     pytest --cov=shipping --cov-report=xml
      - name: Test with pytest and generate coverage report
        continue-on-error: true
        run: |
          pytest test_shipping_fee.py --cov=shipping --cov-report=xml:coverage.xml --cov-branch -v

      # Bước 5: Chạy SonarCloud Scanner để phân tích và đẩy kết quả lên
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@ffc3010689be73b8e5ae0c57ce35968afd7909e8
        env:
          # GITHUB_TOKEN là một secret đặc biệt, tự động có sẵn trong GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # SONAR_TOKEN là secret bạn đã tạo và lưu vào repository
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN2 }}
